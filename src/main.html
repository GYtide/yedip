<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dip</title>
</head>
<link rel="stylesheet" href="./css/index.css">
<link rel="stylesheet" href="./css/attrList.css">

<body>
    <div>

        <div class="wrapper">
            <div class="tool item">
                <button class="toolbtn" onclick="importImage()">导入图片</button>
                <button class="toolbtn" onclick="importlnImage()">示例(莱娜图)</button>
                <!-- <button onclick="flagFn(this,'pencil')">铅笔</button>
                <button onclick="flagFn(this, 'rectH');">矩形框</button>
                <button onclick="flagFn(this, 'ellipse');">椭圆-空心</button>
                <button onclick="export2json()">导出画布</button>
                <select id="selectColor" onchange="selectColorFn(this);">
                    <option value="red">红色</option>
                    <option value="blue">蓝色</option>
                    <option value="green">绿色</option>
                </select> -->
                <button class="toolbtn" onclick="removeFn();">清空画板</button>
            </div>
            <div class="sketchpad item ">
                <div id="container"></div>

            </div>
            <!-- <div id="container"></div> -->
            <div class="attr-list item">

                <input type="radio" id="hotRank" name="radio" checked />
                <label class="index" for="hotRank">画板信息</label>
                <input type="radio" id="commentRank" name="radio" />
                <label class="index" for="commentRank">图片属性</label>
                <div class="content">
                    <div id="content1">
                        <ul>
                            <li class="contentIndex">
                                <label class="">鼠标位置</label>
                                <br>
                                <label class="attrContent">X :</label>
                                <input id="mousex" type="text" value="" disabled class="attrinfo">
                                <label class="attrContent">Y :</label>
                                <input id="mousey" type="text" value="" disabled class="attrinfo">

                            </li>
                            <li class="contentIndex">
                                <label class="">图形信息</label>
                                <br>
                                <label class="attrContent">ID :</label>
                                <input id="bmpid" type="text" value="" disabled class="attrinfo">
                                <label class="attrContent">INDEX:</label>
                                <input id="bmpindex" type="text" value="" disabled class="attrinfo">
                            </li>
                            <li class="contentIndex">
                                <label class="">图像位置</label>
                                <br>
                                <label class="attrContent">X :</label>
                                <input id="bmpx" type="text" value="" disabled class="attrinfo">
                                <label class="attrContent">Y :</label>
                                <input id="bmpy" type="text" value="" disabled class="attrinfo">
                            </li>
                            <li class="contentIndex">
                                <label class="">灰度变化</label>
                                <br>
                                <button class="attrbtn" onclick="return2src()">还原为原图</button>
                                <button class="attrbtn" onclick="rgb2gray()">加权灰度化</button>
                                <button class="attrbtn" onclick="rgb2gray('mean')">平均灰度化</button>
                                <button class="attrbtn" onclick="Equalization()">均衡直方图</button>
                            </li>
                            <li class="contentIndex">
                                <label class="">噪声抑制</label>
                                <br>
                                <button class="attrbtn" onclick="addGaussiannoise()">添加随机噪声</button>
                                <button class="attrbtn" onclick="addPretzelnoise()">添加椒盐噪声</button>
                                <button class="attrbtn" onclick="Meanvaluefiltering()">均值滤波</button>
                                <button class="attrbtn" onclick="Medianvaluefiltering()">中值滤波</button>
                            </li>
                            <li class="contentIndex">
                                <label class="">锐化和边缘检测</label>
                                <br>
                                <button class="attrbtn" onclick="Horizontalsharpening()">水平一阶锐化</button>
                                <button class="attrbtn" onclick="rgb2gray('mean')">二阶微分锐化</button>
                            </li>
                            <li class="contentIndex">
                                <label class="">分割测量</label>
                                <br>
                                <button class="attrbtn" onclick="rgb2gray()">迭代阈值分割</button>
                                <button class="attrbtn" onclick="rgb2gray('mean')">边界分割</button>
                            </li>
                            <li class="contentIndex">
                                <label class="">二值处理</label>
                                <br>
                                <button class="attrbtn" onclick="rgb2gray()">二值化</button>
                                <button class="attrbtn" onclick="rgb2gray()">水平腐蚀</button>
                                <button class="attrbtn" onclick="rgb2gray('mean')">水平膨胀</button>
                                <button class="attrbtn" onclick="rgb2gray('mean')">孤立点去除</button>
                            </li>
                            <li class="contentIndex">
                                <label class="attrchoice">使用 Transformer :</label>
                                <input id="transformer" style="zoom: 150%;" type="checkbox"
                                    onclick="transformerOclick(this)" value="" class="attrinfo" checked="checked">
                                <div style="font-size: 10px;">
                                    注：绘图框架的 transformer 只会有视图层变化，不会影响我们要操作的文件数据的实际数值
                                </div>
                            </li>

                        </ul>
                    </div>
                    <div id="content2">
                        <div style="padding: 20px;">
                            <li class="table-cell">
                                文件名：
                            </li>
                            <li class="table-cell">
                                <input type="text" disabled id="fname">
                            </li>
                        </div>

                        位图文件头
                        <div class="table" id="fileheader">
                            <div class="table-row-group">
                                <ul class="table-row">
                                    <li class="table-cell">
                                        文件类型
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="bfType">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        文件大小
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="bfSize">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        位图数据
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="bfOffBits">
                                    </li>
                                </ul>
                            </div>
                        </div>
                        位图信息头
                        <div class="table" id="infotable">
                            <div class="table-row-group">
                                <ul class="table-row">
                                    <li class="table-cell">
                                        信息头大小
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biSize">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        图像宽度
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biWidth">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        图像高度
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biHeight">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        位面数
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biPlanes">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        像素位数
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biBitCount">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        是否压缩
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biCompression">
                                    </li>
                                </ul>
                                <ul class="table-row">
                                    <li class="table-cell">
                                        颜色数
                                    </li>
                                    <li class="table-cell">
                                        <input type="text" disabled id="biClrUsed">
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="histogram item">
                <div class="echart-rgb-box" id="rchart"></div>
                <div class="echart-rgb-box" id="gchart"></div>
                <div class="echart-rgb-box" id="bchart"></div>
                <!-- <div class="" id="rchart"></div>
                <div class="" id="gchart"></div>
                <div class="" id="bchart"></div> -->
                <div class="echart-gray-box" id="graychart"></div>

            </div>
            <!-- <div class="controlPanel item"></div> -->
            <!-- <div class="six item">Six</div> -->

        </div>
</body>
<script src="../lib/konva/konva.js"></script>
<script src="../src/store/konvaindex.js"></script>
<script src="./store/attrList.js"></script>
<script src="./store/store.js"></script>
<script src="../lib/echarts/echarts.min.js"></script>
<script>
    // import * as fs from 'fs';
    // 文件读取模块
    const fs = require('fs')
    const path = require('path')
    const { FileParser } = require(path.join(path.resolve(__dirname), 'store', 'Fileloader.js'))

    let drawShape = [], // 绘制的图形数组
        graphNow = null, // 当前图形
        flag = null, // 激活绘制-铅笔 pencil:铅笔 ellipse:椭圆 rect:矩形 rectH:矩形-空心
        drawing = false, // 绘制中
        graphColor = 'red',
        pointStart = []; // 初始坐标

    // var 

    // =======================全局监控变量==============
    // 是否显示  Transformer 
    var transformer = document.getElementById('transformer')

    // 鼠标坐标
    var mousex = document.getElementById('mousex')
    var mousey = document.getElementById('mousey')

    //当前选中图形的 id
    var bmpid = document.getElementById('bmpid')
    //当前选中图形的 index （场上所有图像的相对顺序）
    var bmpindex = document.getElementById('bmpindex')
    // 当前选中图形的 坐标

    var bmpx = document.getElementById('bmpx')
    var bmpy = document.getElementById('bmpy')
    function importImage() {
        let input = document.createElement('input');
        input.type = 'file';
        input.onchange = _this => {
            let file = Array.from(input.files)[0];
            console.log(file);
            if (!file.type.includes('image/bmp')) {
                alert('只能导入 BMP 位图');
                return;
            }
            else {
               
                var imageObj = new Image();
                imageObj.onload = function () {
                    drawImage(this)
                }
                try {
                    //读取文件

                    imageObj.src =  file.path
                } catch (err) {
                    console.log(err);
                    alert("文件读取失败")
                    return
                }


            }
        };
        input.click();

    }
    function importlnImage() {
        var imageObj = new Image();
        imageObj.onload = function () {
            drawImage(this)
        }
        try {
            //读取文件

            imageObj.src = path.join(path.resolve(__dirname, '..'), 'res', 'ln.BMP')
        } catch (err) {
            console.log(err);
            alert("文件读取失败")
            return
        }
        // 
    }

    // 选择颜色
    function selectColorFn(t) {
        graphColor = t.value;
    }

    // 移除图形,清空画布
    function removeFn() {
        // 清除 Transformer
        let trans = stage.find('Transformer')

        for (let i = 0; i < trans.length; ++i) {
            trans[i].destroy()
        }

        // 清除图形

        aShape = stage.children[0].children

        // destroy 后 aShape的长度会改变，
        let alength = aShape.length

        for (let i = 0; i < alength; ++i) {
            aShape[0].destroy()
        }
        aShape = stage.children[0].children

        bmpid.value = ""
        bmpindex.value = ""
        bmpx.value = ""
        bmpy.value = ""
        // console.log(aShape)
        // console.log('========================')

        // 清空直方图
        graphNow = null
        updateImageinfoPan()
        clearHistogram()

    }

    // 1 create stage 创建 konva 画布和图层
    const stage = new Konva.Stage({
        container: 'container',
        width: 1100,
        height: 700
    });

    // 2 create layer
    const layer = new Konva.Layer();
    stage.add(layer);



    // 移除改变大小事件

    stage.on('mousedown', function (e) {

        // 如果点击空白处 移除图形选择框
        if (e.target === stage) {
            console.log('========================')
            // console.log(aShape.length, '   ', aShape)
            // console.log()

            // stageMousedown(flag, e);

            //错误原因 查找后为 Transformer 对象的数组遍历删除

            // 遍历移除图形选择框
            // stage.find('Transformer').destroy();

            let trans = stage.find('Transformer')

            for (let i = 0; i < trans.length; ++i) {
                trans[i].destroy()
            }
            // 清空现在活动图形的信息
            bmpid.value = ""
            bmpindex.value = ""
            bmpx.value = ""
            bmpy.value = ""
            graphNow = null
            updateImageinfoPan()
            clearHistogram()

            layer.draw();
            return;
        }
        // 如果没有匹配到就终止往下执行
        if (!e.target.hasName('line') && !e.target.hasName('ellipse') && !e.target.hasName('rect') && !e.target.hasName('circle') && !e.target.hasName('image')) {

            return;
        }
        // 移除图形选择框
        // stage.find('Transformer').destroy();

        let trans = stage.find('Transformer')

        for (let i = 0; i < trans.length; ++i) {
            trans[i].destroy()
        }

        // aShape = stage.children[0].children


        // 当前点击的对象赋值给graphNow
        graphNow = e.target;

        console.log(graphNow)

        // console.log(catx)

        bmpid.value = graphNow._id
        bmpindex.value = graphNow.index

        bmpx.value = graphNow.attrs.x
        bmpy.value = graphNow.attrs.y

        // 创建该图形的直方图
        updateImageinfoPan()

        clearHistogram()
        let cans = graphNow.getImage().getContext('2d')

        let catx = cans.getImageData(0, 0, cans.canvas.width, cans.canvas.height)

        let imdata = catx.data

        let hisdata = histogramData(imdata)

        if (graphNow.type == 'rgb') {

            // console.log(hisdata)
            drawHistogram("rchart", hisdata.rNumber, "直方图R", ['#ff0000'], hisdata.rmax);
            drawHistogram("gchart", hisdata.gNumber, "直方图G", ['#00ff00'], hisdata.gmax);
            drawHistogram("bchart", hisdata.bNumber, "直方图B", ['#0000ff'], hisdata.bmax);
        }
        else {
            // 画出灰度直方图
            drawHistogram("graychart", hisdata.rNumber, "灰度直方图", ['#111111'], hisdata.rmax);
        }



        // 如果允许使用 Transformer 创建图形选框事件
        if (!transformer.checked) {
            return
        }
        const tr = new Konva.Transformer({
            borderStroke: '#000', // 虚线颜色
            borderStrokeWidth: 1, //虚线大小
            borderDash: [5], // 虚线间距
            keepRatio: false // 不等比缩放
        });
        layer.add(tr);
        tr.attachTo(e.target);
        layer.draw();
    });

    // 

    // 鼠标移动
    stage.on('mousemove', function (e) {
        // console.log(e)
        if (graphNow && flag && drawing) {
            stageMousemove(flag, e);
        }
    });

    // 鼠标指针移动,显示鼠标实时坐标
    stage.on('pointermove', function (e) {
        // console.log(e.evt.layerX)
        mousex.value = e.evt.layerX
        // console.log(mousex)
        mousey.value = e.evt.layerY

    })

    stage.on('mouseleave', function () {
        // 鼠标移出画布是
        mousex.value = ""
        mousey.value = ""
    })

    // 鼠标放开
    stage.on('mouseup', function () {
        drawing = false;
        if (flag === 'text') flag = null;
    });

    function export2json() {
        var json = stage.toJSON();
        console.log(json)


    }


    // 监控 checkbox 事件,如果转为不使用 transformer 状态，清除现有的 transformer 框
    function transformerOclick(checkbox) {
        if (!checkbox.checked) {
            // 清除所有 transformer 框
            let trans = stage.find('Transformer')

            for (let i = 0; i < trans.length; ++i) {
                trans[i].destroy()
            }
        }
        else {
            if (graphNow) {
                const tr = new Konva.Transformer({
                    borderStroke: '#000', // 虚线颜色
                    borderStrokeWidth: 1, //虚线大小
                    borderDash: [5], // 虚线间距
                    keepRatio: false // 不等比缩放
                });
                layer.add(tr);
                tr.attachTo(graphNow);
                layer.draw();
            }
        }

    }


</script>

</html>